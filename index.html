<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Tracker Field Force</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet"/>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#0e2a47',
                        accent: '#00d4ff',
                        darkbg: '#0f2027',
                        cardbg: '#1e2e3e',
                        inputbg: '#324a5f',
                        success: '#28a745',
                        danger: '#f44336'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    backgroundImage: {
                        'main-gradient': 'linear-gradient(to bottom right, #0f2027, #203a43, #2c5364)',
                    }
                }
            }
        }
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            background: linear-gradient(to bottom right, #0f2027, #203a43, #2c5364);
            color: #f1f1f1;
            height: 100vh;
            overflow: hidden;
        }
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e2e3e; 
        }
        ::-webkit-scrollbar-thumb {
            background: #324a5f; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #00d4ff; 
        }
        .leaflet-container {
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
            z-index: 0;
            cursor: crosshair;
        }
        /* Leaflet Popup Text Fix */
        .leaflet-popup-content-wrapper {
            background: #1e2e3e;
            color: #fff;
            border: 1px solid #00d4ff;
        }
        .leaflet-popup-tip {
            background: #1e2e3e;
            border: 1px solid #00d4ff;
        }
        .leaflet-popup-close-button {
            color: #00d4ff !important;
        }

        /* Legacy Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            background: #2b3d50;
        }
        th, td {
            border: 1px solid #00d4ff;
            padding: 10px;
            text-align: left;
        }
        th {
            background: #324a5f;
            color: #f1f1f1;
        }
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active{
            -webkit-box-shadow: 0 0 0 30px #324a5f inset !important;
            -webkit-text-fill-color: white !important;
        }
        /* Form Input Styling */
        .proto-input {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: none;
            background: #324a5f;
            color: #fff;
            outline: none;
        }
        .location-cell {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONSTANTS ---
        const SUPABASE_URL = 'https://qqgmqskvjmmdhxeccnip.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFxZ21xc2t2am1tZGh4ZWNjbmlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxOTYyMzYsImV4cCI6MjA3NTc3MjIzNn0.nv2e6zq4VtxYRVrC1BUW1_omGWzsmcXcHoNploqBwX4';

        // --- SUPABASE SETUP ---
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const handleSupabaseError = (err) => {
            console.error("Supabase Error Full Object:", err);
            
            if (err?.code === 'PGRST202' || (err?.message && err.message.includes('Could not find the function'))) {
                alert("DATABASE UPDATE REQUIRED\n\nThe secure login function is missing.\n\nPlease go to Supabase -> SQL Editor and Run the SQL script provided.");
                return;
            }

            if (err?.code === 'PGRST205' || (err?.message && err.message.includes('Could not find the table'))) {
                alert("DATABASE SETUP REQUIRED\n\nThe database tables do not exist.");
                return;
            }
            if (err?.code === '42501' || (err?.message && err.message.includes('row-level security policy'))) {
                alert("ACCESS DENIED (RLS Enabled)\n\nSupabase is blocking the write request because Row Level Security is ON.");
                return;
            }
            let msg = "Unknown error occurred";
            if (typeof err === 'string') msg = err;
            else if (err?.message) msg = typeof err.message === 'string' ? err.message : JSON.stringify(err.message);
            
            alert(`Operation Failed:\n${msg}`);
        };

        // --- SERVICES & HELPERS ---

        const exportToCSV = (data, filename) => {
            if (!data || !data.length) return alert('No data to export');
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => {
                    let val = row[header] === null || row[header] === undefined ? '' : row[header];
                    val = String(val).replace(/"/g, '""');
                    if (val.includes(',')) val = `"${val}"`;
                    return val;
                }).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- COMPONENTS ---

        const Icons = {
            Dashboard: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>,
            Activity: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>,
            FollowUp: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>,
            Profile: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>,
            Users: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>,
            Admin: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>,
            Logout: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>,
            Menu: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>,
            Close: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>,
            Check: () => <svg className="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path></svg>,
            Error: () => <svg className="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>,
            Map: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 p-4 backdrop-blur-sm">
                    <div className="bg-cardbg rounded-lg shadow-2xl w-full max-w-md relative flex flex-col max-h-[90vh] border border-accent">
                        <div className="flex justify-between items-center p-4 border-b border-gray-700">
                            <h3 className="text-xl font-bold text-white">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white">
                                <Icons.Close />
                            </button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- UPDATED MAP COMPONENT WITH DYNAMIC POPUP REFRESH ---
        const MapComponent = ({ lat, lng, pathCoordinates, currentAddress }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markerRef = useRef(null);
            const polylineRef = useRef(null);
            const startMarkerRef = useRef(null);

            // 1. Initialize Map
            useEffect(() => {
                if (!mapRef.current || !window.L) return;
                const L = window.L;

                if (!mapInstanceRef.current) {
                    mapInstanceRef.current = L.map(mapRef.current).setView([lat || 0, lng || 0], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(mapInstanceRef.current);
                }
            }, []);

            // 2. Handle Marker & Popup Logic (Re-runs when address or location changes)
            useEffect(() => {
                if (!mapInstanceRef.current || !window.L) return;
                const L = window.L;

                // Move Map view
                if (lat && lng) {
                    mapInstanceRef.current.flyTo([lat, lng], 16, { animate: true, duration: 1 });
                }

                if (lat && lng) {
                    // Determine display text
                    let addressDisplay = 'Fetching address...';
                    if (currentAddress && currentAddress !== 'Loading...' && currentAddress !== 'N/A') {
                        addressDisplay = currentAddress;
                    }

                    const popupContent = `
                        <div style="min-width: 180px">
                            <h4 style="margin: 0; color: #00d4ff; font-weight: bold;">üìç Location</h4>
                            <p style="margin: 4px 0; font-size: 13px; line-height: 1.4;">${addressDisplay}</p>
                            <div style="font-size: 10px; color: #888; border-top: 1px solid #555; margin-top: 4px; padding-top: 4px;">
                                ${lat.toFixed(6)}, ${lng.toFixed(6)}
                            </div>
                        </div>
                    `;

                    if (markerRef.current) {
                        markerRef.current.setLatLng([lat, lng]);
                        // VITAL FIX: Update the popup content dynamically so it changes from "Fetching..." to "123 Street"
                        if (markerRef.current.getPopup()) {
                            markerRef.current.setPopupContent(popupContent);
                        } else {
                            markerRef.current.bindPopup(popupContent);
                        }
                    } else {
                        markerRef.current = L.marker([lat, lng]).addTo(mapInstanceRef.current);
                        markerRef.current.bindPopup(popupContent).openPopup();
                    }
                }

                // Handle Polyline
                if (pathCoordinates && pathCoordinates.length > 0) {
                    const latLngs = pathCoordinates.map(p => [p.lat, p.lng]);
                    if (polylineRef.current) polylineRef.current.setLatLngs(latLngs);
                    else polylineRef.current = L.polyline(latLngs, { color: '#00d4ff', weight: 4 }).addTo(mapInstanceRef.current);

                    if (latLngs.length > 0) {
                        if (!startMarkerRef.current) {
                            const startIcon = L.icon({
                                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            });
                            startMarkerRef.current = L.marker(latLngs[0], { icon: startIcon }).addTo(mapInstanceRef.current);
                            startMarkerRef.current.bindPopup("Start Point");
                        } else {
                            startMarkerRef.current.setLatLng(latLngs[0]);
                        }
                    }
                } else {
                    if (polylineRef.current) { polylineRef.current.remove(); polylineRef.current = null; }
                    if (startMarkerRef.current) { startMarkerRef.current.remove(); startMarkerRef.current = null; }
                }

                setTimeout(() => mapInstanceRef.current?.invalidateSize(), 100);

            }, [lat, lng, pathCoordinates, currentAddress]); 

            return <div ref={mapRef} className="h-full w-full rounded border border-accent z-0 relative cursor-crosshair"></div>;
        };

        const EmployeeTracker = ({ isOpen, onClose, employees }) => {
            const [selectedEmp, setSelectedEmp] = useState('');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(false);
            const [pathCoords, setPathCoords] = useState([]);
            const liveUpdateRef = useRef(null);

            useEffect(() => {
                if (selectedEmp && selectedDate && isOpen) {
                    fetchLogs();
                    const today = new Date().toISOString().split('T')[0];
                    if (selectedDate === today) liveUpdateRef.current = setInterval(fetchLogs, 5000);
                } else {
                    setLogs([]);
                    setPathCoords([]);
                    if (liveUpdateRef.current) clearInterval(liveUpdateRef.current);
                }
                return () => { if (liveUpdateRef.current) clearInterval(liveUpdateRef.current); };
            }, [selectedEmp, selectedDate, isOpen]);

            const fetchLogs = async () => {
                if (!logs.length) setLoading(true);
                const { data, error } = await supabase.from('daily_activity').select('*')
                    .eq('user_id', selectedEmp)
                    .gte('created_at', `${selectedDate}T00:00:00`)
                    .lte('created_at', `${selectedDate}T23:59:59`)
                    .order('created_at', { ascending: true });

                if (error) handleSupabaseError(error);
                else if (data) {
                    setLogs(data);
                    const coords = data.filter(l => l.latitude && l.longitude).map(l => ({ lat: l.latitude, lng: l.longitude }));
                    setPathCoords(coords);
                }
                setLoading(false);
            };

            const changeDate = (days) => {
                const d = new Date(selectedDate);
                d.setDate(d.getDate() + days);
                setSelectedDate(d.toISOString().split('T')[0]);
            };

            if (!isOpen) return null;
            const lastLoc = pathCoords.length > 0 ? pathCoords[pathCoords.length - 1] : { lat: 0, lng: 0 };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 p-4 backdrop-blur-sm">
                    <div className="bg-cardbg rounded-lg shadow-2xl w-full max-w-4xl relative flex flex-col h-[90vh] border border-accent">
                        <div className="flex justify-between items-center p-4 border-b border-gray-700">
                            <h3 className="text-xl font-bold text-white flex items-center gap-2"><Icons.Map /> Live Tracking Monitor</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white"><Icons.Close /></button>
                        </div>
                        <div className="p-4 grid grid-cols-1 md:grid-cols-3 gap-4 bg-primary border-b border-gray-700">
                            <div>
                                <label className="block text-xs font-bold text-gray-400 mb-1">Select User</label>
                                <select value={selectedEmp} onChange={e => setSelectedEmp(e.target.value)} className="proto-input text-sm">
                                    <option value="">-- Choose User --</option>
                                    {employees.map(emp => <option key={emp.user_id} value={emp.user_id}>{emp.name} ({emp.role === 'admin' ? 'Admin' : 'Emp'})</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-400 mb-1">Select Date</label>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => changeDate(-1)} className="p-2 bg-inputbg rounded hover:bg-accent hover:text-black">‚óÄ</button>
                                    <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="proto-input text-sm flex-1" />
                                    <button onClick={() => changeDate(1)} className="p-2 bg-inputbg rounded hover:bg-accent hover:text-black">‚ñ∂</button>
                                </div>
                            </div>
                            <div className="flex items-end">
                                <button onClick={fetchLogs} disabled={!selectedEmp || loading} className="w-full bg-accent text-black font-bold py-2 px-4 rounded hover:bg-cyan-400 disabled:opacity-50 text-sm">
                                    {loading && logs.length === 0 ? 'Loading...' : 'Refresh Now'}
                                </button>
                            </div>
                        </div>
                        <div className="flex-1 relative bg-gray-900">
                            {pathCoords.length > 0 ? <MapComponent lat={lastLoc.lat} lng={lastLoc.lng} pathCoordinates={pathCoords} currentAddress="Tracking Mode" /> : (
                                <div className="h-full flex items-center justify-center text-gray-400 flex-col gap-2"><Icons.Map /><p>Select a user to view live route.</p></div>
                            )}
                        </div>
                        <div className="h-40 overflow-y-auto bg-darkbg border-t border-gray-700 p-4">
                            <h4 className="text-sm font-bold text-accent mb-2">Activity Log ({logs.length})</h4>
                            <div className="space-y-2">
                                {logs.map((log, idx) => (
                                    <div key={idx} className="flex text-xs text-gray-300 border-b border-gray-700 pb-1">
                                        <span className="w-20 font-mono text-gray-500">{new Date(log.created_at).toLocaleTimeString()}</span>
                                        <span className={`font-bold w-20 ${log.type === 'checkin' ? 'text-green-400' : log.type === 'checkout' ? 'text-red-400' : 'text-blue-400'}`}>{log.type.toUpperCase()}</span>
                                        <span className="flex-1 truncate">{log.location}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const DailyActivity = ({ user }) => {
            const [logs, setLogs] = useState([]);
            const [employees, setEmployees] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filterDate, setFilterDate] = useState(new Date().toISOString().split('T')[0]);
            const [filterEmp, setFilterEmp] = useState('');
            const [search, setSearch] = useState('');
            const [checkInSession, setCheckInSession] = useState(localStorage.getItem(`checkin_${user.user_id}`));
            const [myGpsLoc, setMyGpsLoc] = useState(null);
            const [mapMarkerLoc, setMapMarkerLoc] = useState(null);
            
            // New state to hold the resolved address for the map
            const [displayAddress, setDisplayAddress] = useState('Fetching address...');
            
            const [pathCoords, setPathCoords] = useState([]);
            const [addressCache, setAddressCache] = useState({});
            const [showVisitModal, setShowVisitModal] = useState(false);
            const [showEmployeeModal, setShowEmployeeModal] = useState(false);
            const [isLiveTracking, setIsLiveTracking] = useState(false);
            const [visitData, setVisitData] = useState({ client: '', purpose: '', location: '' });
            
            const trackingIntervalRef = useRef(null);
            const livePollingRef = useRef(null);
            const watchIdRef = useRef(null);
            const latestPosRef = useRef(null);

            useEffect(() => {
                if(user.role === 'admin') {
                    supabase.from('users').select('user_id, name, role').in('role', ['employee', 'admin']).order('name').then(({data}) => {
                        if(data) setEmployees(data);
                    });
                }
            }, [user]);

            // Helper to get address but also return it locally for the map logic
            const resolveAddress = async (lat, lng) => {
                if (!lat || !lng) return 'N/A';
                const key = `${lat.toFixed(4)}_${lng.toFixed(4)}`;
                if (addressCache[key]) return addressCache[key];
                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                    const data = await response.json();
                    const addr = data.display_name || 'Unknown Location';
                    
                    setAddressCache(prev => ({ ...prev, [key]: addr }));
                    return addr;
                } catch { 
                    return 'Address unavailable'; 
                }
            };

            // EFFECT: Watch Map Marker changes and update address
            useEffect(() => {
                let isMounted = true;
                if (mapMarkerLoc && mapMarkerLoc.lat && mapMarkerLoc.lng) {
                    setDisplayAddress('Fetching address...'); // Reset to loading state
                    resolveAddress(mapMarkerLoc.lat, mapMarkerLoc.lng).then(addr => {
                        if(isMounted) setDisplayAddress(addr);
                    });
                } else {
                    setDisplayAddress('');
                }
                return () => { isMounted = false; };
            }, [mapMarkerLoc]);


            const fetchLogs = async () => {
                if (!isLiveTracking) setLoading(true);
                let query = supabase.from('daily_activity').select('*').order('created_at', { ascending: false });
                if (user.role === 'employee') query = query.eq('user_id', user.user_id);
                else if (filterEmp) query = query.eq('user_id', filterEmp);
                
                const { data, error } = await query;
                if (error) handleSupabaseError(error);
                else if (data) {
                    let filtered = data.filter(l => new Date(l.created_at).toISOString().startsWith(filterDate));
                    if (search) {
                        const s = search.toLowerCase();
                        filtered = filtered.filter(l => l.user_id.toLowerCase().includes(s) || (l.description && l.description.toLowerCase().includes(s)));
                    }
                    setLogs(filtered);
                    
                    // Pre-fetch addresses for table
                    filtered.forEach(l => { 
                        if(l.latitude && l.longitude) resolveAddress(l.latitude, l.longitude); 
                    });
                    
                    const sortedForPath = [...filtered].sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());
                    const coords = sortedForPath.filter(l => l.latitude && l.longitude).map(l => ({ lat: l.latitude, lng: l.longitude }));
                    setPathCoords(coords);

                    if (isLiveTracking && coords.length > 0) {
                        const lastPoint = coords[coords.length - 1];
                        setMapMarkerLoc({ lat: lastPoint.lat, lng: lastPoint.lng, acc: 0 });
                    } else if (!mapMarkerLoc && (!filterEmp || filterEmp === user.user_id) && myGpsLoc) {
                        setMapMarkerLoc(myGpsLoc);
                    }
                }
                setLoading(false);
            };

            useEffect(() => { fetchLogs(); }, [filterDate, filterEmp, search]);

            useEffect(() => {
                if (isLiveTracking && filterEmp) livePollingRef.current = setInterval(fetchLogs, 10000);
                else if (livePollingRef.current) clearInterval(livePollingRef.current);
                return () => { if (livePollingRef.current) clearInterval(livePollingRef.current); };
            }, [isLiveTracking, filterEmp]);

            const getLocation = () => new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(pos => {
                    const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy };
                    setMyGpsLoc(loc);
                    if ((!filterEmp || filterEmp === user.user_id) && !isLiveTracking) setMapMarkerLoc(loc);
                    resolve(loc);
                }, err => reject(err), { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
            });

            useEffect(() => { getLocation(); }, []);

            useEffect(() => {
                if (checkInSession) {
                    if (!watchIdRef.current) {
                        watchIdRef.current = navigator.geolocation.watchPosition(
                            pos => {
                                const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy };
                                latestPosRef.current = loc; 
                                setMyGpsLoc(loc);
                                if ((!filterEmp || filterEmp === user.user_id) && !isLiveTracking) setMapMarkerLoc(loc);
                            },
                            err => console.warn("GPS Watch Error:", err),
                            { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
                        );
                    }

                    trackingIntervalRef.current = setInterval(async () => {
                        try {
                            const loc = latestPosRef.current || await getLocation();
                            if (loc && loc.lat && loc.lng) {
                                await supabase.from('daily_activity').insert([{
                                    user_id: user.user_id,
                                    type: 'tracking',
                                    created_at: new Date().toISOString(),
                                    latitude: loc.lat,
                                    longitude: loc.lng,
                                    location: 'En Route',
                                    description: 'Auto Tracking',
                                    details: `Session: ${checkInSession}`
                                }]);
                                if (!filterEmp || filterEmp === user.user_id) fetchLogs(); 
                            }
                        } catch (e) { console.warn("Tracking upload failed", e); }
                    }, 10000); 

                } else {
                    if (trackingIntervalRef.current) clearInterval(trackingIntervalRef.current);
                    if (watchIdRef.current) { navigator.geolocation.clearWatch(watchIdRef.current); watchIdRef.current = null; }
                }

                return () => { 
                    if (trackingIntervalRef.current) clearInterval(trackingIntervalRef.current);
                    if (watchIdRef.current) { navigator.geolocation.clearWatch(watchIdRef.current); watchIdRef.current = null; }
                };
            }, [checkInSession, filterEmp, user.user_id]);

            const handleCheckIn = async () => {
                try {
                    if (checkInSession) return alert("Already checked in.");
                    const loc = await getLocation();
                    const addr = await resolveAddress(loc.lat, loc.lng);
                    const { data, error } = await supabase.from('daily_activity').insert([{
                        user_id: user.user_id,
                        type: 'checkin',
                        created_at: new Date().toISOString(),
                        latitude: loc.lat,
                        longitude: loc.lng,
                        location: addr,
                        description: 'Live GPS',
                        details: 'Session Started'
                    }]).select();
                    if (error) throw error;
                    localStorage.setItem(`checkin_${user.user_id}`, data[0].id);
                    setCheckInSession(data[0].id);
                    setVisitData(prev => ({ ...prev, location: `Lat: ${loc.lat.toFixed(6)}, Lng: ${loc.lng.toFixed(6)}` }));
                    setShowVisitModal(true);
                    fetchLogs();
                } catch (err) { handleSupabaseError(err); }
            };

            const handleCheckOut = async () => {
                if (!checkInSession) return alert('Not checked in!');
                try {
                    const loc = await getLocation();
                    const addr = await resolveAddress(loc.lat, loc.lng);
                    const { error } = await supabase.from('daily_activity').insert([{
                        user_id: user.user_id,
                        type: 'checkout',
                        created_at: new Date().toISOString(),
                        latitude: loc.lat,
                        longitude: loc.lng,
                        location: addr,
                        description: 'Live GPS',
                        details: `Linked Checkin ID: ${checkInSession}`
                    }]);
                    if (error) throw error;
                    localStorage.removeItem(`checkin_${user.user_id}`);
                    setCheckInSession(null);
                    fetchLogs();
                    alert('Checked Out Successfully');
                } catch (err) { handleSupabaseError(err); }
            };

            const submitVisit = async () => {
                try {
                    const loc = myGpsLoc || await getLocation();
                    const addr = await resolveAddress(loc.lat, loc.lng);
                    const { error } = await supabase.from('daily_activity').insert([{
                        user_id: user.user_id,
                        type: 'visit',
                        created_at: new Date().toISOString(),
                        latitude: loc.lat,
                        longitude: loc.lng,
                        location: addr,
                        description: `${visitData.client}`,
                        details: `${visitData.purpose}`
                    }]);
                    if (error) throw error;
                    try {
                        await supabase.from('followups').insert([{
                            user_id: user.user_id,
                            subject: `Visit: ${visitData.client}`,
                            followup_date: new Date().toISOString(),
                            notes: `Purpose: ${visitData.purpose}\nLocation: ${addr}`
                        }]);
                    } catch {}
                    alert('Visit Logged');
                    setShowVisitModal(false);
                    setVisitData({ client: '', purpose: '', location: '' });
                    fetchLogs();
                } catch (err) { handleSupabaseError(err); }
            };

            const getEmpName = (id) => {
                const found = employees.find(e => e.user_id === id);
                return found ? found.name : (id === user.user_id ? user.name : id);
            };

            const startTrackingEmployee = (empId) => {
                setFilterEmp(empId);
                setFilterDate(new Date().toISOString().split('T')[0]);
                setIsLiveTracking(true);
                setShowEmployeeModal(false);
            };

            const handleFocusOnMap = (log) => {
                if (log.latitude && log.longitude) {
                    setMapMarkerLoc({ lat: log.latitude, lng: log.longitude, acc: 0 });
                    setIsLiveTracking(false);
                } else alert("No GPS coordinates for this entry.");
            };

            const changeDate = (days) => {
                const d = new Date(filterDate);
                d.setDate(d.getDate() + days);
                setFilterDate(d.toISOString().split('T')[0]);
            };

            return (
                <div className="bg-cardbg p-6 rounded-2xl shadow-lg relative">
                    <h2 className="text-2xl font-bold mb-6 text-white flex items-center justify-between">
                        <span>üìÖ DAILY ACTIVITY</span>
                        {isLiveTracking && <span className="text-xs bg-red-600 animate-pulse px-2 py-1 rounded text-white">LIVE TRACKING ACTIVE</span>}
                    </h2>
                    <div className="flex flex-wrap gap-4 mb-6 items-end">
                        <div className="flex-1 min-w-[150px]">
                            <label className="block text-sm mb-1 font-semibold">Date:</label>
                            <div className="flex items-center gap-1">
                                <button onClick={() => changeDate(-1)} className="px-2 py-2 bg-inputbg rounded hover:bg-accent hover:text-black transition-colors">‚óÄ</button>
                                <input type="date" value={filterDate} onChange={e=>setFilterDate(e.target.value)} className="proto-input"/>
                                <button onClick={() => changeDate(1)} className="px-2 py-2 bg-inputbg rounded hover:bg-accent hover:text-black transition-colors">‚ñ∂</button>
                            </div>
                        </div>
                        {user.role === 'admin' && (
                            <div className="flex-1 min-w-[150px]">
                                <label className="block text-sm mb-1 font-semibold">Filter Logs By:</label>
                                <select value={filterEmp} onChange={e=> { setFilterEmp(e.target.value); setIsLiveTracking(false); }} className="proto-input">
                                    <option value="">All Users</option>
                                    {employees.map(e => <option key={e.user_id} value={e.user_id}>{e.name} ({e.role === 'admin' ? 'Admin' : 'Emp'})</option>)}
                                </select>
                            </div>
                        )}
                        <div className="flex-1 min-w-[150px]">
                            <label className="block text-sm mb-1 font-semibold">üîç Search:</label>
                            <input type="text" placeholder="Employee name / User ID" value={search} onChange={e=>setSearch(e.target.value)} className="proto-input"/>
                        </div>
                    </div>
                    <div className="flex gap-3 mb-6 flex-wrap items-center">
                        <button onClick={handleCheckIn} className="bg-accent text-black font-bold py-2 px-4 rounded hover:bg-cyan-400">Check In</button>
                        <button onClick={handleCheckOut} className="bg-accent text-black font-bold py-2 px-4 rounded hover:bg-cyan-400">Check Out</button>
                        <button onClick={() => exportToCSV(logs, 'Daily_Activity')} className="bg-accent text-black font-bold py-2 px-4 rounded hover:bg-cyan-400">Export All</button>
                        {user.role === 'admin' && (
                            <button onClick={() => setShowEmployeeModal(true)} className="ml-auto bg-green-600 text-white font-bold py-2 px-4 rounded hover:bg-green-500 flex items-center gap-2">
                                <Icons.Map /> Live Track User
                            </button>
                        )}
                    </div>
                    <div className="mb-2 font-bold text-white flex justify-between">
                        <div>üìç Location Status: <span className={myGpsLoc ? "text-success" : "text-danger"}>{myGpsLoc ? "GPS Active" : "Searching..."}</span></div>
                        {isLiveTracking && filterEmp && <div className="text-accent text-sm">Tracking: {getEmpName(filterEmp)}</div>}
                    </div>
                    <div className="flex flex-col md:flex-row gap-4 mb-8 p-4 border border-accent rounded-lg">
                        <div className="flex-1 text-sm space-y-1">
                            <h4 className="font-bold text-accent mb-2 border-b border-gray-600 pb-1">{filterEmp && filterEmp !== user.user_id ? "Tracked User Info" : "My Current Location"}</h4>
                            <p><strong>Address:</strong> {displayAddress}</p>
                            <p><strong>Latitude:</strong> {mapMarkerLoc ? mapMarkerLoc.lat.toFixed(6) : "N/A"}</p>
                            <p><strong>Longitude:</strong> {mapMarkerLoc ? mapMarkerLoc.lng.toFixed(6) : "N/A"}</p>
                            {(!filterEmp || filterEmp === user.user_id) && <p><strong>Accuracy:</strong> {mapMarkerLoc?.acc?.toFixed(2) || "N/A"} meters</p>}
                        </div>
                        <div className="flex-1 h-48 border border-accent rounded relative">
                            {/* PASSED ADDRESS PROP HERE FOR POPUP FIX */}
                            <MapComponent 
                                lat={mapMarkerLoc?.lat || 0} 
                                lng={mapMarkerLoc?.lng || 0} 
                                pathCoordinates={pathCoords} 
                                currentAddress={displayAddress}
                            />
                        </div>
                    </div>
                    <h3 className="text-center text-gray-400 font-semibold mb-2">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Merged Log Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</h3>
                    <div className="overflow-x-auto">
                        <table className="min-w-full text-sm border-collapse">
                            <thead>
                                <tr>
                                    <th>User ID</th><th>Name</th><th>Type</th><th>Date & Time</th><th>Location</th><th>Latitude</th><th>Longitude</th><th>Map</th><th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {loading ? <tr><td colSpan="9" className="text-center p-4">Loading...</td></tr> : logs.map(log => (
                                    <tr key={log.id || Math.random()}>
                                        <td>{log.user_id}</td>
                                        <td>{getEmpName(log.user_id)}</td>
                                        <td className="capitalize">{log.type}</td>
                                        <td>{new Date(log.created_at).toLocaleString()}</td>
                                        <td className="location-cell" title={addressCache[`${log.latitude?.toFixed(4)}_${log.longitude?.toFixed(4)}`] || 'Loading...'}>
                                            {log.location === "Live Location" || log.location === "Client Visit Location" 
                                                ? (addressCache[`${log.latitude?.toFixed(4)}_${log.longitude?.toFixed(4)}`] || 'Loading...') 
                                                : log.location || 'N/A'}
                                        </td>
                                        <td>{log.latitude?.toFixed(6) || 'N/A'}</td>
                                        <td>{log.longitude?.toFixed(6) || 'N/A'}</td>
                                        <td>
                                            {(log.latitude && log.longitude) ? (
                                                <div className="flex flex-col gap-1">
                                                    <button onClick={() => handleFocusOnMap(log)} className="text-white bg-accent/20 hover:bg-accent hover:text-black border border-accent rounded px-2 py-1 text-xs font-bold transition-colors text-center">üéØ Focus</button>
                                                    <a href={`https://www.openstreetmap.org/?mlat=${log.latitude}&mlon=${log.longitude}`} target="_blank" className="text-gray-400 hover:text-white text-xs flex items-center justify-center gap-1"><span>üîó Open Ext</span></a>
                                                </div>
                                            ) : 'N/A'}
                                        </td>
                                        <td>{log.description ? `${log.description} ${log.details || ''}` : log.details || 'N/A'}</td>
                                    </tr>
                                ))}
                                {!loading && logs.length === 0 && <tr><td colSpan="9" className="text-center p-4">No daily activity records found</td></tr>}
                            </tbody>
                        </table>
                    </div>
                    {showVisitModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 p-4 backdrop-blur-sm">
                            <div className="bg-cardbg rounded-lg shadow-2xl w-full max-w-md relative flex flex-col border border-accent">
                                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                                    <h3 className="text-xl font-bold text-white">üìù Log Visit?</h3>
                                    <button onClick={() => setShowVisitModal(false)} className="text-gray-400 hover:text-white"><Icons.Close /></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div><label className="block mb-1 text-sm font-bold">Client Name:</label><input type="text" className="proto-input" placeholder="Client/Company Name" value={visitData.client} onChange={e=>setVisitData({...visitData, client: e.target.value})} /></div>
                                    <div><label className="block mb-1 text-sm font-bold">Visit Purpose:</label><textarea className="proto-input" rows="3" placeholder="Purpose / Notes" value={visitData.purpose} onChange={e=>setVisitData({...visitData, purpose: e.target.value})}></textarea></div>
                                    <div><label className="block mb-1 text-sm font-bold">Visit Location:</label><input type="text" className="proto-input" value={visitData.location} readOnly /></div>
                                    <div className="flex gap-2 pt-2 justify-center"><button onClick={submitVisit} className="bg-accent text-black font-bold py-2 px-6 rounded">‚úîÔ∏è Submit Visit</button><button onClick={() => setShowVisitModal(false)} className="bg-danger text-white font-bold py-2 px-6 rounded">Skip Visit</button></div>
                                </div>
                            </div>
                        </div>
                    )}
                    {showEmployeeModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 p-4 backdrop-blur-sm">
                            <div className="bg-cardbg rounded-lg shadow-2xl w-full max-w-sm relative flex flex-col border border-accent">
                                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                                    <h3 className="text-xl font-bold text-white">Select User to Track</h3>
                                    <button onClick={() => setShowEmployeeModal(false)} className="text-gray-400 hover:text-white"><Icons.Close /></button>
                                </div>
                                <div className="p-6 overflow-y-auto max-h-[60vh]">
                                    <div className="space-y-2">
                                        {employees.map(emp => (
                                            <button key={emp.user_id} onClick={() => startTrackingEmployee(emp.user_id)} className="w-full text-left p-3 rounded bg-inputbg hover:bg-accent hover:text-black transition-colors flex items-center justify-between group">
                                                <div><div className="font-bold">{emp.name}</div><div className="text-xs text-gray-400 group-hover:text-gray-800">{emp.user_id} ({emp.role === 'admin' ? 'Admin' : 'Emp'})</div></div>
                                                <Icons.Map />
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const FollowUps = ({ user }) => {
            const [list, setList] = useState([]);
            const [loading, setLoading] = useState(true);
            const [newF, setNewF] = useState({ subject: '', datetime: '', note: '' });
            const subjectRef = useRef(null);

            useEffect(() => { fetchF(); }, [user]);

            const fetchF = async () => {
                setLoading(true);
                let query = supabase.from('followups').select('*').order('followup_date', { ascending: true });
                if (user.role === 'employee') query = query.eq('user_id', user.user_id);
                const { data, error } = await query;
                if (error) handleSupabaseError(error); else if (data) setList(data);
                setLoading(false);
            };

            const handleAdd = async (e) => {
                e.preventDefault();
                const payload = { user_id: user.user_id, subject: newF.subject, followup_date: newF.datetime, notes: newF.note };
                let { error } = await supabase.from('followups').insert([payload]);
                if (!error) { setNewF({ subject: '', datetime: '', note: '' }); fetchF(); alert('Follow-up added successfully!'); } 
                else handleSupabaseError(error);
            };

            const handleDelete = async (id) => {
                if(!confirm('Delete this follow-up?')) return;
                const { error } = await supabase.from('followups').delete().eq('id', id);
                if (error) handleSupabaseError(error); else fetchF();
            };

            return (
                <div className="bg-cardbg p-6 rounded-2xl shadow-lg">
                    <h2 className="text-2xl font-bold mb-4 text-white">Follow Ups</h2>
                    <div className="flex gap-3 mb-4 flex-wrap">
                        <button onClick={() => subjectRef.current.focus()} className="bg-accent text-black font-bold py-2 px-4 rounded hover:bg-cyan-400">Add Follow-Up</button>
                        <button onClick={() => exportToCSV(list, 'FollowUps')} className="bg-accent text-black font-bold py-2 px-4 rounded hover:bg-cyan-400">Export to Excel</button>
                    </div>
                    <form onSubmit={handleAdd} className="space-y-3 mb-8">
                        <input ref={subjectRef} type="text" placeholder="Subject / Client Name" className="proto-input" value={newF.subject} onChange={e=>setNewF({...newF, subject: e.target.value})} required />
                        <input type="datetime-local" className="proto-input" value={newF.datetime} onChange={e=>setNewF({...newF, datetime: e.target.value})} required />
                        <textarea placeholder="Reminder Note" className="proto-input" value={newF.note} onChange={e=>setNewF({...newF, note: e.target.value})} rows="2"></textarea>
                        <button type="submit" className="bg-accent text-black font-bold py-2 px-6 rounded hover:bg-cyan-400">Save Follow-Up</button>
                    </form>
                    <div className="overflow-x-auto">
                        <table className="min-w-full text-sm border-collapse">
                            <thead>
                                <tr>{user.role === 'admin' && <th>User ID</th>}<th>Subject</th><th>Date & Time</th><th>Note</th><th>Actions</th></tr>
                            </thead>
                            <tbody>
                                {loading ? <tr><td colSpan="6" className="text-center p-4">Loading...</td></tr> : list.map(item => (
                                    <tr key={item.id}>
                                        {user.role === 'admin' && <td>{item.user_id}</td>}
                                        <td>{item.subject}</td>
                                        <td>{new Date(item.followup_date).toLocaleString()}</td>
                                        <td>{item.notes}</td>
                                        <td><button onClick={() => handleDelete(item.id)} className="bg-white text-black text-xs font-bold py-1 px-3 rounded hover:bg-gray-200">Delete</button></td>
                                    </tr>
                                ))}
                                {!loading && list.length === 0 && <tr><td colSpan="6" className="text-center p-4">No follow-up records found</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const UserProfile = ({ user, onUpdate }) => {
            const [formData, setFormData] = useState(user);
            const [photoPreview, setPhotoPreview] = useState(user.photo_url || 'https://via.placeholder.com/100');

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => { setPhotoPreview(reader.result); setFormData({...formData, photo_url: reader.result}); };
                    reader.readAsDataURL(file);
                }
            };

            const handleSave = async () => {
                const { error } = await supabase.from('users').update({ name: formData.name, mobile_no: formData.mobile_no, password: formData.password, photo_url: formData.photo_url }).eq('user_id', user.user_id);
                if (error) handleSupabaseError(error);
                else { alert('Profile Saved'); onUpdate(formData); }
            };

            return (
                <div className="bg-cardbg p-6 rounded-xl shadow-lg max-w-lg mx-auto">
                    <h2 className="text-2xl font-bold mb-6 text-center">User Profile</h2>
                    <div className="flex flex-col items-center mb-6">
                        <img src={photoPreview} alt="Profile" className="w-24 h-24 rounded-full object-cover border-4 border-accent mb-2" />
                        <label className="text-accent cursor-pointer text-sm hover:underline">Upload Photo<input type="file" className="hidden" accept="image/*" onChange={handleFileChange} /></label>
                    </div>
                    <div className="space-y-4">
                        <div><label className="block text-sm mb-1">Name</label><input type="text" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} className="proto-input" /></div>
                        <div><label className="block text-sm mb-1">Employee ID</label><input type="text" value={formData.user_id} readOnly className="w-full bg-gray-700 p-2 rounded text-gray-400 cursor-not-allowed" /></div>
                        <div><label className="block text-sm mb-1">Mobile</label><input type="text" value={formData.mobile_no} onChange={e=>setFormData({...formData, mobile_no: e.target.value})} className="proto-input" /></div>
                        <div><label className="block text-sm mb-1">Password</label><input type="password" value={formData.password} onChange={e=>setFormData({...formData, password: e.target.value})} className="proto-input" /></div>
                        <button onClick={handleSave} className="w-full bg-success text-white font-bold py-2 rounded mt-4">Save Profile</button>
                    </div>
                </div>
            );
        };

        const AdminManagement = ({ type }) => {
            const [users, setUsers] = useState([]);
            const [isModalOpen, setModalOpen] = useState(false);
            const [newUser, setNewUser] = useState({ id: '', name: '', mobile: '', email: '', password: '' });

            useEffect(() => { fetchUsers(); }, [type, isModalOpen]);

            const fetchUsers = async () => {
                const role = type === 'admin' ? 'admin' : 'employee';
                // SECURE: Fetch from DB (server-side), not local storage
                const { data, error } = await supabase.from('users').select('user_id, name, mobile_no, email, role').eq('role', role);
                if (data) setUsers(data);
            };

            const handleDelete = async (id) => {
                if (confirm(`Delete ${id}?`)) {
                    try { await supabase.from('users').delete().eq('user_id', id); } catch(e){}
                    fetchUsers();
                }
            };

            const handleAdd = async (e) => {
                e.preventDefault();
                const prefix = type === 'admin' ? 'ADM' : 'SCS';
                let userId = newUser.id.trim();
                if (!userId.toUpperCase().startsWith(prefix + '-')) return alert(`ID must start with ${prefix}-`);

                const newUserObj = { user_id: userId.toUpperCase(), name: newUser.name, mobile_no: newUser.mobile, email: newUser.email, password: newUser.password, role: type === 'admin' ? 'admin' : 'employee' };
                const { error } = await supabase.from('users').upsert([newUserObj]);
                if (error) return handleSupabaseError(error);
                
                setModalOpen(false); setNewUser({ id: '', name: '', mobile: '', email: '', password: '' });
                alert('User added successfully'); fetchUsers();
            };

            return (
                <div className="bg-cardbg p-4 rounded-xl shadow-lg">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold">{type === 'admin' ? 'Admin Profile Details' : 'Employee Details'}</h2>
                        <div className="flex gap-2">
                            <button onClick={() => { setNewUser({ id: '', name: '', mobile: '', email: '', password: '' }); setModalOpen(true); }} className="bg-accent text-black font-bold py-2 px-4 rounded">Add {type === 'admin' ? 'Admin' : 'Employee'}</button>
                            <button onClick={() => exportToCSV(users, type + '_list')} className="bg-green-600 text-white font-bold py-2 px-4 rounded">Export</button>
                        </div>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full text-sm">
                            <thead><tr><th>{type === 'admin' ? 'Employee ID' : 'Employee ID'}</th><th>Name</th><th>Mobile No</th><th>Email</th><th>Actions</th></tr></thead>
                            <tbody>
                                {users.map(u => (
                                    <tr key={u.user_id}><td>{u.user_id}</td><td>{u.name}</td><td>{u.mobile_no}</td><td>{u.email || 'N/A'}</td><td><button onClick={() => handleDelete(u.user_id)} className="text-red-400 hover:text-red-200">Delete</button></td></tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <Modal isOpen={isModalOpen} onClose={() => setModalOpen(false)} title={`Add New ${type === 'admin' ? 'Admin' : 'Employee'}`}>
                        <form onSubmit={handleAdd} className="space-y-4">
                            <div><label className="block mb-1 text-sm font-bold text-white">{type === 'admin' ? 'Admin Username' : 'Employee ID'}</label><input type="text" placeholder={type === 'admin' ? 'ADM-John' : 'SCS-12345'} className="proto-input" value={newUser.id} onChange={e=>setNewUser({...newUser, id: e.target.value})} required/></div>
                            <div><label className="block mb-1 text-sm font-bold text-white">Full Name</label><input type="text" placeholder="John Doe" className="proto-input" value={newUser.name} onChange={e=>setNewUser({...newUser, name: e.target.value})} required/></div>
                            <div><label className="block mb-1 text-sm font-bold text-white">Mobile No</label><input type="tel" placeholder="9876543210" className="proto-input" value={newUser.mobile} onChange={e=>setNewUser({...newUser, mobile: e.target.value})} required/></div>
                            <div><label className="block mb-1 text-sm font-bold text-white">Email</label><input type="email" placeholder="john@example.com" className="proto-input" value={newUser.email} onChange={e=>setNewUser({...newUser, email: e.target.value})} /></div>
                            <div><label className="block mb-1 text-sm font-bold text-white">Password</label><input type="password" placeholder="Set password" className="proto-input" value={newUser.password} onChange={e=>setNewUser({...newUser, password: e.target.value})} required/></div>
                            <button type="submit" className="w-full bg-accent text-black font-bold py-3 rounded mt-4">Save {type === 'admin' ? 'Admin' : 'Employee'}</button>
                        </form>
                    </Modal>
                </div>
            );
        };

        const Login = ({ onLogin }) => {
            const [form, setForm] = useState({ role: '', id: '', password: '', mobile: '' });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(''); setLoading(true);
                try {
                    if (!form.role) throw new Error('Please select a role');
                    if (!form.id) throw new Error('ID is required');

                    // MODIFIED: Client-Side Login (Operated by Localhost logic)
                    // Fetches user data and verifies credentials in the browser
                    const { data, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('user_id', form.id.trim())
                        .single();

                    if (error) {
                         // Handle specific Supabase errors
                        if (error.code === 'PGRST116') throw new Error('User ID not found.');
                        if (error.code === '42501') throw new Error('Access Denied. Database Policy (RLS) blocking read.');
                        throw error;
                    }

                    if (!data) throw new Error('User not found.');

                    // Validate Password (Local Check)
                    if (data.password !== form.password) throw new Error('Invalid Password');
                    
                    // Validate Other Details
                    if (data.role !== form.role) throw new Error('Incorrect Role selected.');
                    if (data.mobile_no !== form.mobile) throw new Error('Incorrect Mobile Number.');

                    onLogin(data);
                } catch (err) { 
                    console.error(err);
                    setError(err.message || 'Login failed'); 
                }
                finally { setLoading(false); }
            };

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className="hidden md:flex w-64 bg-primary flex-col items-center p-6 border-r border-gray-700">
                        <h1 className="text-2xl font-bold text-accent mb-10 flex items-center gap-2">üöÄ Tracker</h1>
                        <div className="relative w-24 h-24 rounded-full border-2 border-accent flex items-center justify-center mb-2 bg-gray-800"><span className="text-center text-xs text-white">Profile<br/>Photo</span></div>
                        <div className="text-center mb-8"><p className="text-white font-semibold">Employee Name</p><p className="text-gray-400 text-sm">EMP-ID</p></div>
                        <div className="w-full mt-auto mb-auto"><button className="w-full bg-accent text-black font-bold py-3 rounded-lg shadow-lg mb-4">Login</button></div>
                    </aside>
                    <main className="flex-1 bg-main-gradient p-8 md:p-16 overflow-y-auto flex flex-col justify-center">
                        <div className="w-full max-w-3xl mx-auto">
                            <h2 className="text-3xl font-bold text-white mb-8">Login</h2>
                            {error && <div className="bg-red-500/20 border border-red-500 text-red-200 p-3 rounded mb-4 text-sm text-center font-semibold">{error}</div>}
                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div className="form-group"><label className="block text-white font-bold mb-2">{form.role === 'admin' ? 'Admin Username' : 'Employee ID'}</label><input type="text" placeholder={form.role === 'admin' ? 'Enter Admin Username' : 'Enter Employee ID'} className="proto-input focus:ring-2 focus:ring-accent" value={form.id} onChange={e => setForm({...form, id: e.target.value})} required /></div>
                                <div className="form-group"><label className="block text-white font-bold mb-2">Mobile Number</label><input type="tel" placeholder="Enter your mobile number" className="proto-input focus:ring-2 focus:ring-accent" value={form.mobile} onChange={e => setForm({...form, mobile: e.target.value})} required /></div>
                                <div className="form-group"><label className="block text-white font-bold mb-2">Select Role</label><select className="proto-input focus:ring-2 focus:ring-accent" value={form.role} onChange={e => setForm({...form, role: e.target.value})} required><option value="">-- Select Role --</option><option value="employee">Employee</option><option value="admin">Admin</option></select></div>
                                <div className="form-group"><label className="block text-white font-bold mb-2">Password</label><input type="password" placeholder="Enter your password" className="proto-input focus:ring-2 focus:ring-accent" value={form.password} onChange={e => setForm({...form, password: e.target.value})} required /></div>
                                <button type="submit" disabled={loading} className="w-auto min-w-[120px] bg-accent hover:bg-cyan-400 text-black font-bold py-3 px-6 rounded-lg transition-all mt-6 disabled:opacity-50">{loading ? 'Logging in...' : 'Login'}</button>
                            </form>
                        </div>
                    </main>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [section, setSection] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [showTrackerModal, setShowTrackerModal] = useState(false);
            const [dbConnected, setDbConnected] = useState(null);
            const [employeeList, setEmployeeList] = useState([]);

            useEffect(() => {
                const saved = localStorage.getItem('current_user_session');
                if (saved) setUser(JSON.parse(saved));
                checkDb();
            }, []);

            useEffect(() => {
                if(user?.role === 'admin') fetchEmployees();
            }, [user]);

            const checkDb = async () => {
                const { error } = await supabase.from('daily_activity').select('id').limit(1);
                setDbConnected(!error);
            };

            const fetchEmployees = async () => {
                // SECURE: Fetch from DB (All users: Admin + Employee)
                const { data } = await supabase.from('users').select('user_id, name, role').in('role', ['employee', 'admin']).order('name');
                if(data) setEmployeeList(data);
            };

            const handleLogin = (u) => {
                setUser(u);
                localStorage.setItem('current_user_session', JSON.stringify(u));
            };

            const handleLogout = () => {
                setUser(null);
                localStorage.removeItem('current_user_session');
                setSection('dashboard');
            };

            if (!user) return <Login onLogin={handleLogin} />;

            return (
                <div className="flex h-screen overflow-hidden">
                    <button onClick={() => setSidebarOpen(!sidebarOpen)} className="md:hidden fixed top-4 right-4 z-50 p-2 bg-cardbg rounded-md text-accent">{sidebarOpen ? <Icons.Close /> : <Icons.Menu />}</button>
                    <aside className={`fixed inset-y-0 left-0 z-40 w-64 bg-primary transform transition-transform duration-300 ease-in-out ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 flex flex-col`}>
                        <div className="p-6 flex flex-col items-center border-b border-gray-700">
                            <h1 className="text-2xl font-bold text-accent mb-4">üöÄ Tracker</h1>
                            <img src={user.photo_url || 'https://via.placeholder.com/80'} alt="Profile" className="w-20 h-20 rounded-full object-cover border-2 border-accent mb-2" />
                            <p className="font-semibold text-white text-center">{user.name}</p>
                            <p className="text-xs text-gray-400">{user.user_id}</p>
                        </div>
                        <div className="px-6 py-2">
                            <div className={`text-xs font-bold px-2 py-1 rounded text-center ${dbConnected ? 'bg-green-900 text-green-200' : 'bg-red-900 text-red-200 animate-pulse'}`}>DB Status: {dbConnected === null ? 'Checking...' : (dbConnected ? 'Connected' : 'Error / RLS Blocked')}</div>
                        </div>
                        <nav className="flex-1 overflow-y-auto p-4 space-y-2">
                            <button onClick={() => { setSection('dashboard'); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 p-3 rounded-lg transition-colors ${section === 'dashboard' ? 'bg-accent text-black font-bold' : 'hover:bg-cardbg text-gray-300'}`}><Icons.Dashboard /> Dashboard</button>
                            <button onClick={() => { setSection('activity'); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 p-3 rounded-lg transition-colors ${section === 'activity' ? 'bg-accent text-black font-bold' : 'hover:bg-cardbg text-gray-300'}`}><Icons.Activity /> Daily Activity</button>
                            <button onClick={() => { setSection('followups'); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 p-3 rounded-lg transition-colors ${section === 'followups' ? 'bg-accent text-black font-bold' : 'hover:bg-cardbg text-gray-300'}`}><Icons.FollowUp /> Follow Ups</button>
                            <button onClick={() => { setSection('profile'); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 p-3 rounded-lg transition-colors ${section === 'profile' ? 'bg-accent text-black font-bold' : 'hover:bg-cardbg text-gray-300'}`}><Icons.Profile /> User Profile</button>
                            {user.role === 'admin' && (
                                <div className="border-t border-gray-700 my-2 pt-2">
                                    <p className="text-xs text-gray-500 uppercase px-2 mb-1">Admin Zone</p>
                                    <button onClick={() => { setSection('manage-emp'); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 p-3 rounded-lg transition-colors ${section === 'manage-emp' ? 'bg-accent text-black font-bold' : 'hover:bg-cardbg text-gray-300'}`}><Icons.Users /> Manage Employees</button>
                                    <button onClick={() => { setSection('manage-admin'); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 p-3 rounded-lg transition-colors ${section === 'manage-admin' ? 'bg-accent text-black font-bold' : 'hover:bg-cardbg text-gray-300'}`}><Icons.Admin /> Manage Admins</button>
                                    <button onClick={() => { setShowTrackerModal(true); setSidebarOpen(false); }} className="w-full flex items-center gap-3 p-3 rounded-lg transition-colors hover:bg-cardbg text-accent font-bold border border-accent/20 hover:border-accent mt-2"><Icons.Map /> Live Tracking</button>
                                </div>
                            )}
                        </nav>
                        <div className="p-4 border-t border-gray-700">
                            <button onClick={handleLogout} className="w-full flex items-center justify-center gap-2 p-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors"><Icons.Logout /> Logout</button>
                        </div>
                    </aside>
                    <main className="flex-1 overflow-y-auto bg-main-gradient p-4 md:p-8">
                        {section === 'dashboard' && <div className="bg-cardbg p-6 rounded-2xl shadow-lg"><h2 className="text-2xl font-bold mb-4">Welcome, {user.name}</h2><ul className="space-y-3 text-gray-300"><li className="flex items-center gap-2"><Icons.Activity/> <strong>Mark Attendance:</strong> Easily clock in and out.</li><li className="flex items-center gap-2"><Icons.FollowUp/> <strong>Daily Visit Records:</strong> Log your client visits.</li><li className="flex items-center gap-2"><Icons.Users/> <strong>Follow Ups:</strong> Manage daily follow-ups.</li></ul></div>}
                        {section === 'activity' && <DailyActivity user={user} />}
                        {section === 'followups' && <FollowUps user={user} />}
                        {section === 'profile' && <UserProfile user={user} onUpdate={handleLogin} />}
                        {section === 'manage-emp' && user.role === 'admin' && <AdminManagement type="employee" />}
                        {section === 'manage-admin' && user.role === 'admin' && <AdminManagement type="admin" />}
                    </main>
                    <EmployeeTracker isOpen={showTrackerModal} onClose={() => setShowTrackerModal(false)} employees={employeeList} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
